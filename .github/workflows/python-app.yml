name: ML CI Pipeline

on:
  push:
    branches: [ main ]
    tags:
      - "v1.*"
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        pip install uv 
        uv sync
      #  pip install -r requirements.txt

      # Linting dÃ©sactivÃ©
      # - name: Run linting with flake8
      #   run: |
      #     flake8 .

    - name: Set up environment variables
      run: |
        echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> $GITHUB_ENV
        
    - name: Run tests
      run: |        
        uv run pytest test/
      # pip install pytest

    - name: Train model (test run)
      run: |
        uv run python -m src.train --epochs 1

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v1.')
    permissions:
      contents: write

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Push to Hugging Face Space
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: |
        git config --global user.email "ci@github.com"
        git config --global user.name "GitHub Actions"

        git clone https://oauth2:$HF_TOKEN@huggingface.co/spaces/MarcBo-eng/P05_openc.git hf-space

        rsync -av --delete \
          --exclude='.git' \
          --exclude='__pycache__' \
          --exclude='*.pyc' \
          --exclude='.pytest_cache' \
          --exclude='htmlcov' \
          --exclude='.coverage' \          
          ./ hf-space/ || true

        # Ajouter la configuration au fichier README.md sans effacer le contenu existant
        echo -e "\n---\ntitle: \"P05 Openc\"\nemoji: \"ðŸ“‰\"\ncolorFrom: \"red\"\ncolorTo: \"indigo\"\nsdk: docker\nsdk_version: \"3.0\"\npython_version: \"3.10\"\napp_file: app.py\npinned: false\nshort_description: Projet05_OpenC\n---\n" | cat - hf-space/README.md > hf-space/README.md.tmp && mv hf-space/README.md.tmp hf-space/README.md

        cd hf-space
        git add .
        git commit -m "Deploy ${{ github.ref_name }}" || echo "Nothing to commit"
        # git pull --rebase https://oauth2:$HF_TOKEN@huggingface.co/spaces/MarcBo-eng/P05_openc.git main || true
        git push https://oauth2:$HF_TOKEN@huggingface.co/spaces/MarcBo-eng/P05_openc.git main
